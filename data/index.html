<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Light Sync</title>
  <link rel="icon" type="image/png" href="carlightsync64.png">
  <link href="style.css" rel="stylesheet" />
</head>

<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <img src="carlightsync64.png" alt="Logo" class="loading-logo">
      <h2 data-i18n="loading.title">Chargement...</h2>
      <div class="loading-progress">
        <div id="loading-progress-bar" class="loading-progress-bar"></div>
      </div>
      <p id="loading-status" data-i18n="loading.connecting">Javascript & Styles</p>
      <div id="loading-ble-button" class="loading-ble-actions" style="display: none;">
        <button onclick="manualBleConnect()" class="btn-primary" data-i18n="loading.connectBle"></button>
      </div>
      <div id="loading-error" class="loading-error" style="display: none;">
        <p id="loading-error-message"></p>
        <div class="loading-error-actions">
          <button onclick="restart()" class="btn-secondary" data-i18n="loading.restart"></button>
          <button onclick="factoryReset()" class="btn-danger" data-i18n="loading.factoryReset"></button>
          <button onclick="retryLoading()" class="btn-primary" data-i18n="loading.retry"></button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="header-logo">
        <img src="carlightsync64.png" alt="Car Light Sync Logo">
      </div>
      <div class="header-content">
        <h1 data-i18n="app.title"></h1>
        <p data-i18n="app.subtitle"></p>
      </div>
      <div class="header-controls">
        <button id="language-toggle" class="icon-toggle-btn" onclick="toggleLanguage()" title="Language / Langue">
          <span id="language-icon">FR</span>
        </button>
        <button id="theme-toggle" class="icon-toggle-btn" onclick="toggleTheme()" title="Theme">
          <span id="theme-icon">☀️</span>
        </button>
      </div>
    </div>
    <div id="ble-notification" class="notification"></div>
    <div class="status-bar">
      <div id="ble-status-item" class="status-item status-item-ble" hidden>
        <button id="ble-connect-button" class="btn-secondary ble-icon-button" onclick="toggleBleConnection()"
          title="BLE"></button>
        <div class="status-item">
          <div class="status-label" data-i18n="ble.title"></div>
          <div class="status-value" id="ble-status-text" data-i18n="ble.disconnected"></div>
        </div>
      </div>
      <div id="wifi-status-item" class="status-item">
        <div class="status-label" data-i18n="status.wifi"></div>
        <div class="status-value" id="wifi-status">...</div>
      </div>
      <div class="status-item status-item-can">
        <div class="status-label" data-i18n="status.system"></div>
        <div class="status-can-group">
          <div class="status-can-item">
            <span class="status-can-label">CPU:</span>
            <div class="status-progress-container">
              <div class="status-progress-bar">
                <div class="status-progress-fill" id="cpu-bar"></div>
              </div>
              <span class="status-percentage status-value" id="cpu-status">...</span>
            </div>
          </div>
          <div class="status-can-item">
            <span class="status-can-label" data-i18n="status.memoryLabel"></span>
            <div class="status-progress-container">
              <div class="status-progress-bar">
                <div class="status-progress-fill" id="memory-bar"></div>
              </div>
              <span class="status-percentage status-value" id="memory-status">...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="status-item" id="status-vehicle">
        <div class="status-label" data-i18n="status.vehicle"></div>
        <div class="status-value" id="vehicle-status">...</div>
      </div>
      <div class="status-item status-item-can" id="status-can">
        <div class="status-label" data-i18n="status.canBus"></div>
        <div class="status-can-group">
          <div class="status-can-item">
            <span class="status-can-label">Chassis:</span>
            <span class="status-value" id="can-chassis-status">...</span>
          </div>
          <div class="status-can-item">
            <span class="status-can-label">Body:</span>
            <span class="status-value" id="can-body-status">...</span>
          </div>
        </div>
      </div>
      <div class="status-item" id="status-espnow" style="display: none;">
        <div class="status-label">ESP-NOW</div>
        <div class="status-value" id="espnow-status">slave</div>
      </div>
      <div class="status-item">
        <div class="status-label" data-i18n="status.profile"></div>
        <div class="status-value" id="profile-status">...</div>
      </div>
    </div>
    <div id="app-wrapper" class="app-wrapper">
      <div id="app-content" class="app-content">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="profiles" onclick="switchTab('profiles', event)"
            data-i18n="tabs.profiles"></button>
          <button class="tab" data-tab="events-config" onclick="switchTab('events-config', event)"
            data-i18n="tabs.eventsConfig"></button>
          <button class="tab" id="tab-vehicle" data-tab="vehicle" onclick="switchTab('vehicle', event)"
            data-i18n="tabs.vehicle"></button>
          <button class="tab" data-tab="config" onclick="switchTab('config', event)"
            data-i18n="tabs.hardware"></button>
          <button class="tab" data-tab="espnow" onclick="switchTab('espnow', event)"
            data-i18n="tabs.espnow"></button>
          <button class="tab" id="tab-diagnostic" data-tab="diagnostic" onclick="switchTab('diagnostic', event)"
            data-i18n="tabs.diagnostic"></button>
          <button class="tab" id="logs-tab-button" data-tab="logs" onclick="switchTab('logs', event)"
            data-i18n="tabs.logs" style="display: none;"></button>
          <button class="tab" data-tab="ota" onclick="switchTab('ota', event)" data-i18n="tabs.ota"></button>
        </div>
        <!-- Tab: Profils -->
        <div id="profiles-tab" class="tab-content active">
          <div class="section-title" data-i18n="profiles.title"></div>
          <div id="profiles-notification" class="notification"></div>

          <!-- Section: Sélection du profil -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="profiles.profileSelection"></h3>
            </div>
            <div class="profile-section-content">
              <div class="control-group">
                <label class="control-label" data-i18n="profiles.activeProfile"></label>
                <select id="profile-select" onchange="activateProfile()">
                  <option value="-1" data-i18n="profiles.loading"></option>
                </select>
              </div>
              <div class="control-group" id="storage-info" style="margin-top: 10px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <label class="control-label" data-i18n="profiles.storage"></label>
                  <span id="storage-text" style="font-size: 0.9em; color: #aaa;">-</span>
                </div>
                <div style="width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
                  <div id="storage-bar"
                    style="height: 100%; background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336); width: 0%; transition: width 0.3s;">
                  </div>
                </div>
              </div>
              <div class="button-group">
                <button id="profile-new-button" class="btn-secondary" onclick="showNewProfileDialog()"
                  data-i18n="profiles.new"></button>
                <button class="btn-secondary" onclick="showRenameProfileDialog()"
                  data-i18n="profiles.rename"></button>
                <button class="btn-danger" onclick="deleteProfile()" data-i18n="profiles.delete"></button>
                <button class="btn-secondary" onclick="exportProfile()" data-i18n="profiles.export"></button>
                <button id="profile-import-button" class="btn-secondary" onclick="showImportDialog()"
                  data-i18n="profiles.import"></button>
              </div>
            </div>
          </div>

          <!-- Section: Luminosité Dynamique -->
          <div class="profile-section" id="dynamic-brightness-section">
            <div class="profile-section-header">
              <h3 data-i18n="profiles.dynamicBrightness"></h3>
              <p data-i18n="profiles.dynamicBrightnessDesc"></p>
            </div>
            <div class="profile-section-content">
              <label class="toggle-container" for="dynamic-brightness-enabled">
                <div class="toggle-switch">
                  <input type="checkbox" id="dynamic-brightness-enabled">
                  <span class="toggle-slider"></span>
                </div>
                <span class="toggle-label" data-i18n="profiles.dynamicBrightnessEnable"></span>
              </label>
              <div class="control-group" style="margin-top: 15px;">
                <label class="control-label" data-i18n="profiles.dynamicBrightnessRate"></label>
                <div class="slider-container">
                  <input type="range" id="dynamic-brightness-rate" min="1" max="100" value="50">
                  <span class="slider-value" id="dynamic-brightness-rate-value">50%</span>
                </div>
                <p style="font-size: 12px; color: var(--color-muted); margin-top: 8px;"
                  data-i18n="profiles.dynamicBrightnessHelp">
                </p>
              </div>
            </div>
          </div>

          <!-- Section: Effet par Défaut -->
          <div class="profile-section" id="default-effect-section">
            <div class="profile-section-header">
              <h3 data-i18n="profiles.defaultEffect"></h3>
              <p data-i18n="profiles.defaultEffectDesc"></p>
            </div>
            <div class="profile-section-content default-effect-grid">
              <div class="default-effect-card">
                <div class="control-group">
                  <label class="control-label" data-i18n="effects.effect"></label>
                  <select id="default-effect-select" data-effect-options="true">
                    <!-- Will be populated dynamically -->
                  </select>
                </div>
                <div class="default-effect-inline">
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.brightness"></label>
                    <div class="slider-container">
                      <input type="range" id="default-brightness-slider" min="1" max="100" value="50">
                      <span class="slider-value" id="default-brightness-value">50%</span>
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.speed"></label>
                    <div class="slider-container">
                      <input type="range" id="default-speed-slider" min="1" max="100" value="50">
                      <span class="slider-value" id="default-speed-value">50%</span>
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.color"></label>
                    <div class="color-picker">
                      <input type="color" id="default-color1" value="#ff0000">
                    </div>
                  </div>
                </div>
                <div class="control-group" style="margin: 0;">
                  <label class="control-label" data-i18n="eventsConfig.segmentRange"></label>
                  <div class="segment-range-container">
                    <div class="segment-range-slider" id="default-segment-range">
                      <div class="segment-range-track"></div>
                      <div class="segment-range-selected" id="default-segment-range-selected"></div>
                      <input type="range" min="0" max="300" step="1" value="0" class="segment-range-min"
                        id="default-segment-range-min" oninput="updateDefaultSegmentRange()">
                      <input type="range" min="0" max="300" step="1" value="300" class="segment-range-max"
                        id="default-segment-range-max" oninput="updateDefaultSegmentRange()">
                    </div>
                    <div class="segment-range-values">
                      <span data-i18n="eventsConfig.start"></span>: <span id="default-segment-value-start">0</span>
                      |
                      <span data-i18n="eventsConfig.length"></span>: <span
                        id="default-segment-value-length">300</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="default-effect-card">
                <div class="default-effect-stack">
                  <label class="toggle-container" for="default-reverse">
                    <div class="toggle-switch">
                      <input type="checkbox" id="default-reverse">
                      <span class="toggle-slider"></span>
                    </div>
                    <span class="toggle-label" data-i18n="eventsConfig.reverse"></span>
                  </label>
                  <label class="toggle-container" for="default-audio-reactive">
                    <div class="toggle-switch">
                      <input type="checkbox" id="default-audio-reactive">
                      <span class="toggle-slider"></span>
                    </div>
                    <span class="toggle-label" data-i18n="effects.audioReactiveMode"></span>
                  </label>
                </div>
                <hr>
                <div class="default-effect-stack">                  
                  <div class="control-group" style="margin: 0;">
                    <label class="toggle-container" for="default-accel-pedal-enabled">
                      <div class="toggle-switch">
                        <input type="checkbox" id="default-accel-pedal-enabled">
                        <span class="toggle-slider"></span>
                      </div>
                      <span class="toggle-label" data-i18n="effects.accelPedalEnabled"></span>
                    </label>
                    <p class="default-effect-subtitle" data-i18n="effects.accelPedalEnabledDesc">
                    </p>
                  </div>
                  <div class="control-group" style="margin: 0;">
                    <label class="control-label" data-i18n="effects.accelPedalOffset"></label>
                    <div class="slider-container">
                      <input type="range" id="default-accel-pedal-offset-slider" min="0" max="100" value="0">
                      <span class="slider-value" id="default-accel-pedal-offset-value">0%</span>
                    </div>
                    <p class="default-effect-subtitle" data-i18n="effects.accelPedalOffsetDesc">
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tab: Events Configuration -->
        <div id="events-config-tab" class="tab-content">
          <div class="section-title" data-i18n="eventsConfig.title"></div>
          <div id="events-notification" class="notification"></div>
          <div id="events-loading" class="loading" data-i18n="eventsConfig.loading">
          </div>
          <div id="events-content" style="display: none;">
            <p style="margin-bottom: 20px; color: var(--color-muted); font-size: 14px;"
              data-i18n="eventsConfig.description">
            </p>
            <div class="control-group" style="margin-bottom: 20px;">
              <label class="control-label" data-i18n="eventsConfig.filter"></label>
              <input type="text" id="events-filter-input" data-i18n-placeholder="eventsConfig.filterPlaceholder"
                oninput="filterEvents(this.value)"
                style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--color-input-border); background: var(--color-input); color: var(--color-text);">
            </div>
            <div class="events-accordion-wrapper">
              <div id="events-accordion-container">
                <!-- Will be populated dynamically with accordion items -->
              </div>
            </div>
            <button class="btn-secondary" onclick="loadEventsConfig()"
              data-i18n="eventsConfig.reload"></button>
          </div>
        </div>
        <!-- Tab: Véhicule -->
        <div id="vehicle-tab" class="tab-content">
          <div class="section-title" data-i18n="vehicle.title"></div>

          <!-- Section: État général -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.generalState"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.speed"></div>
                  <div class="vehicle-value" id="v-speed">-- km/h</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.gear"></div>
                  <div class="vehicle-value" id="v-gear">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.brake"></div>
                  <div class="vehicle-value" id="v-brake">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.accelPedal"></div>
                  <div class="vehicle-value" id="v-accel-pedal">0%</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.locked"></div>
                  <div class="vehicle-value" id="v-locked">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Portes -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.doorsTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorFL"></div>
                  <div class="vehicle-value" id="v-door-fl">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorFR"></div>
                  <div class="vehicle-value" id="v-door-fr">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorRL"></div>
                  <div class="vehicle-value" id="v-door-rl">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorRR"></div>
                  <div class="vehicle-value" id="v-door-rr">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.trunk"></div>
                  <div class="vehicle-value" id="v-trunk">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.frunk"></div>
                  <div class="vehicle-value" id="v-frunk">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Charge -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.chargeTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.charging"></div>
                  <div class="vehicle-value" id="v-charging">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.chargePercent"></div>
                  <div class="vehicle-value" id="v-charge">--%</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.chargePower"></div>
                  <div class="vehicle-value" id="v-charge-power">-- kW</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Lumières -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.lightsTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.headlights"></div>
                  <div class="vehicle-value" id="v-headlights">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.highBeams"></div>
                  <div class="vehicle-value" id="v-high-beams">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.fogLights"></div>
                  <div class="vehicle-value" id="v-fog-lights">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.turnSignal"></div>
                  <div class="vehicle-value" id="v-turn-signal">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Blindspot -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.blindspot"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotLeft"></div>
                  <div class="vehicle-value" id="v-blindspot-left">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotRight"></div>
                  <div class="vehicle-value" id="v-blindspot-right">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotLeftAlert"></div>
                  <div class="vehicle-value" id="v-blindspot-left-alert">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotRightAlert"></div>
                  <div class="vehicle-value" id="v-blindspot-right-alert">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Side Collision -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.sideCollision"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sideCollisionLeft"></div>
                  <div class="vehicle-value" id="v-side-collision-left">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sideCollisionRight"></div>
                  <div class="vehicle-value" id="v-side-collision-right">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Lane departure -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.laneDeparture"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureLeftLv1"></div>
                  <div class="vehicle-value" id="v-lane-departure-left-lv1">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureLeftLv2"></div>
                  <div class="vehicle-value" id="v-lane-departure-left-lv2">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureRightLv1"></div>
                  <div class="vehicle-value" id="v-lane-departure-right-lv1">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureRightLv2"></div>
                  <div class="vehicle-value" id="v-lane-departure-right-lv2">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Autres -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.othersTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.batterylv"></div>
                  <div class="vehicle-value" id="v-battery-lv">-- V</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.batteryhv"></div>
                  <div class="vehicle-value" id="v-battery-hv">-- V</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.odometer"></div>
                  <div class="vehicle-value" id="v-odometer">-- km</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.nightMode"></div>
                  <div class="vehicle-value" id="v-night">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.brightness"></div>
                  <div class="vehicle-value" id="v-brightness">--</div>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.sentryTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.autopilot"></div>
                  <div class="vehicle-value" id="v-autopilot">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.autopilotAlerte"></div>
                  <div class="vehicle-value" id="v-autopilot-alert">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sentryMode"></div>
                  <div class="vehicle-value" id="v-sentry-mode">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sentryAlert"></div>
                  <div class="vehicle-value" id="v-sentry-alert">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tab: Configuration -->
        <div id="config-tab" class="tab-content">
          <div class="section-title" data-i18n="config.title"></div>
          <div id="config-notification" class="notification"></div>

          <!-- Section: Configuration LED -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="config.ledSettings"></h3>
            </div>
            <div class="profile-section-content">
              <div class="control-group">
                <label class="control-label" data-i18n="config.ledCount"></label>
                <input type="number" id="led-count" value="" min="1" max="200" onchange="saveHardwareConfig()">
              </div>
            </div>
            <div id="wheel-control-section">
              <div class="profile-section-header">
                <h3 data-i18n="config.wheelSettings"></h3>
              </div>
              <div class="profile-section-content">
                <div class="control-row" style="margin-top: 12px;">
                  <label class="toggle-container" for="wheel-control-toggle">
                    <div class="toggle-switch">
                      <input type="checkbox" id="wheel-control-toggle" onchange="saveHardwareConfig()">
                      <span class="toggle-slider"></span>
                    </div>
                    <span class="toggle-label" data-i18n="config.wheelControl"></span>
                  </label>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="config.wheelControlDesc"></label>
                  <div style="display: flex; gap: 10px; align-items: center; max-width: 320px;">
                    <input type="number" id="wheel-speed-limit" min="0" max="100" step="5" value="5" style="width: 120px;"
                      onchange="saveHardwareConfig()">
                    <span data-i18n="config.wheelSpeedLimit"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="button-group" style="margin-top: 20px;">
              <button class="btn-secondary" onclick="loadHardwareConfig()"
                data-i18n="config.reload"></button>
              <button class="btn-danger" onclick="restartDevice()" data-i18n="config.restart"></button>
            </div>
          </div>

          <!-- Section: Configuration Audio -->
          <div class="profile-section" id="audio-section">
            <div class="profile-section-header">
              <h3 data-i18n="audio.title"></h3>
              <p style="padding: 10px; background: rgba(250, 204, 21, 0.1); border-left: 3px solid #FACC15; font-size: 13px; margin-top: 10px;"
                data-i18n="audio.warning">
              </p>
            </div>
            <div class="profile-section-content">
              <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <label class="toggle-container" for="audio-enable">
                  <div class="toggle-switch">
                    <input type="checkbox" id="audio-enable" onchange="toggleAudio(this.checked)">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="audio.enable"></span>
                </label>
                <span id="audio-status" style="font-weight: bold; color: var(--color-muted);"
                  data-i18n="audio.disabled"></span>
              </div>

              <div id="audio-settings" style="display: none;">
                <div class="control-group">
                  <label class="control-label" data-i18n="audio.sensitivity"></label>
                  <div class="slider-container">
                    <input type="range" id="audio-sensitivity" min="1" max="255" value="128"
                      oninput="updateAudioValue('sensitivity', this.value)">
                    <span class="slider-value" id="audio-sensitivity-value">128</span>
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label" data-i18n="audio.gain"></label>
                  <div class="slider-container">
                    <input type="range" id="audio-gain" min="1" max="255" value="128"
                      oninput="updateAudioValue('gain', this.value)">
                    <span class="slider-value" id="audio-gain-value">128</span>
                  </div>
                </div>

                <label class="toggle-container" for="audio-auto-gain">
                  <div class="toggle-switch">
                    <input type="checkbox" id="audio-auto-gain" onchange="saveAudioConfig()">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="audio.autoGain"></span>
                </label>
              </div>

              <div id="audio-calibration-box" class="section"
                style="margin-top: 20px; padding: 15px; background: var(--color-panel); border-radius: 6px;">
                <div
                  style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                  <div>
                    <div class="section-title" data-i18n="audio.calibrationTitle"></div>
                    <div id="audio-calibration-status" style="font-weight: 600; color: var(--color-muted);"
                      data-i18n="audio.notCalibrated"></div>
                    <div style="font-size: 13px; color: var(--color-muted); margin-top: 4px;">
                      <span data-i18n="audio.calibrationNoise"></span>: <strong
                        id="audio-calibration-noise">-</strong>
                      <span style="margin: 0 6px;">|</span>
                      <span data-i18n="audio.calibrationPeak"></span>: <strong id="audio-calibration-peak">-</strong>
                    </div>
                  </div>
                  <button id="audio-calibrate-btn" class="btn-primary" onclick="startAudioCalibration()"
                    data-i18n="audio.calibrate"></button>
                </div>
                <p style="font-size: 12px; color: var(--color-muted); margin: 8px 0 0 0;"
                  data-i18n="audio.calibrationHint">
                </p>
              </div>

              <div id="audio-data" class="section"
                style="margin-top: 20px; padding: 15px; background: var(--color-panel); border-radius: 6px;">
                <h4 style="margin: 0 0 15px 0;" data-i18n="audio.liveData"></h4>
                <div
                  style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                  <div>
                    <span data-i18n="audio.amplitude"></span>:
                    <strong id="audio-amplitude-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.rawAmplitude"></span>:
                    <strong id="audio-raw-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.calibratedAmplitude"></span>:
                    <strong id="audio-calibrated-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.bpm"></span>:
                    <strong id="audio-bpm-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.bass"></span>:
                    <strong id="audio-bass-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.mid"></span>:
                    <strong id="audio-mid-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.treble"></span>:
                    <strong id="audio-treble-value">-</strong>
                  </div>
                </div>
              </div>

              <!-- FFT Advanced Mode -->
              <div id="audio-fft-data" class="section" style="margin-top: 30px;">
                <div class="section-title" data-i18n="fft.title"></div>

                <div
                  style="background: var(--color-info); padding: 10px 15px; border-radius: 6px; margin-bottom: 15px;">
                  <small style="color: var(--color-text);" data-i18n="fft.autoInfo">
                  </small>
                </div>

                <div id="fftStatusBox" style="display: none; margin-top: 10px;">
                  <div
                    style="background: var(--color-surface); padding: 15px; border-radius: 8px; border: 1px solid var(--color-border);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                      <div>
                        <span data-i18n="fft.peakFreq"></span>:
                        <strong id="fftPeakFreq" style="color: #4CAF50;">-</strong> Hz
                      </div>
                      <div>
                        <span data-i18n="fft.centroid"></span>:
                        <strong id="fftCentroid" style="color: #2196F3;">-</strong> Hz
                      </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                      <div>
                        <span data-i18n="fft.kick"></span>:
                        <strong id="fftKick">-</strong>
                      </div>
                      <div>
                        <span data-i18n="fft.snare"></span>:
                        <strong id="fftSnare">-</strong>
                      </div>
                      <div>
                        <span data-i18n="fft.vocal"></span>:
                        <strong id="fftVocal">-</strong>
                      </div>
                    </div>

                    <!-- Canvas pour visualisation spectre -->
                    <div style="margin-top: 15px;">
                      <div style="font-weight: 500; margin-bottom: 8px;" data-i18n="fft.spectrum"></div>
                      <canvas id="fftSpectrumCanvas" width="600" height="200"
                        style="width: 100%; max-width: 600px; background: #000; border-radius: 4px; border: 1px solid var(--color-border);"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Zone Dangereuse -->
          <div class="profile-section" style="border: 2px solid #E82127;">
            <div class="profile-section-header">
              <h3 style="color: #E82127;" data-i18n="config.dangerZone"></h3>
              <p style="padding: 10px; background: rgba(232, 33, 39, 0.1); border-left: 3px solid #E82127; font-size: 13px; margin-top: 10px;"
                data-i18n="config.factoryResetWarning">
              </p>
            </div>
            <div class="profile-section-content">
              <button class="btn-danger" onclick="confirmFactoryReset()"
                data-i18n="config.factoryReset"></button>
            </div>
          </div>
        </div>

        <!-- Tab: ESP-NOW -->
        <div id="espnow-tab" class="tab-content">
          <div class="section-title" data-i18n="espnow.title"></div>
          <div id="espnow-notifications">
            <div id="espnow-notification-config" class="notification"></div>
            <div id="espnow-notification-pairing" class="notification"></div>
            <div id="espnow-notification-peers" class="notification"></div>
            <div id="espnow-notification-test" class="notification"></div>
            <div id="espnow-notification-disconnect" class="notification"></div>
          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="espnow.configTitle"></h3>
              <p style="margin: 6px 0 0 0; color: var(--color-muted);" data-i18n="espnow.configDescription">
              </p>
            </div>
            <div class="profile-section-content">
              <div class="espnow-grid">
                <div class="control-group">
                  <label class="control-label" data-i18n="config.espnowRole"></label>
                  <select id="espnow-role" onchange="saveEspnowConfig()">
                    <option value="master" data-i18n="config.espnowRoleMaster"></option>
                    <option value="slave" data-i18n="config.espnowRoleSlave"></option>
                  </select>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="config.espnowType"></label>
                  <select id="espnow-type" onchange="saveEspnowConfig()">
                  </select>
                </div>
                <div class="espnow-status-card">
                  <div class="espnow-status-label" data-i18n="espnow.channel"></div>
                  <div class="espnow-status-value" id="espnow-channel">--</div>
                  <div class="espnow-status-sub" data-i18n="espnow.channelHelp"></div>
                </div>
              <div class="espnow-status-card">
                <div class="espnow-status-label" data-i18n="espnow.pairingState"></div>
                <div class="espnow-status-value" id="espnow-pairing-state">--</div>
                <div class="espnow-status-sub" id="espnow-role-summary">--</div>
              </div>
              <div class="espnow-status-card">
                <div class="espnow-status-label" data-i18n="espnow.selfTitle"></div>
                <div class="espnow-status-value" id="espnow-self-id">ID: --</div>
                <div class="espnow-status-sub" id="espnow-self-mac">MAC: --</div>
              </div>
            </div>
            <div id="espnow-master-card" class="espnow-master-card" style="display: none;">
              <div class="espnow-master-header" data-i18n="espnow.masterConnected"></div>
              <div class="espnow-master-grid">
                <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterMac"></div>
                    <div class="espnow-master-value" id="espnow-master-mac">--</div>
                  </div>
                  <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterId"></div>
                    <div class="espnow-master-value" id="espnow-master-id">--</div>
                  </div>
                  <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterChannel"></div>
                    <div class="espnow-master-value" id="espnow-master-channel">--</div>
                  </div>
                  <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterLastSeen"></div>
                    <div class="espnow-master-value" id="espnow-master-last">--</div>
                  </div>
                </div>
              </div>
              <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" id="espnow-pairing-button" onclick="startEspnowPairing()" data-i18n="config.espnowPairing"></button>
              </div>
            </div>
          </div>

          <div class="profile-section" id="espnow-peers-section" style="display: none;">
            <div class="profile-section-header">
              <h3 data-i18n="espnow.peersTitle"></h3>
              <p id="espnow-peers-subtitle" style="margin: 6px 0 0 0; color: var(--color-muted);" data-i18n="espnow.peersSubtitle"></p>
            </div>
            <div class="profile-section-content">
              <div id="espnow-peers-empty" style="color: var(--color-muted);" data-i18n="espnow.noPeers"></div>
              <table class="config-table" style="margin-top: 10px; display: none;" id="espnow-peers-table">
                <thead>
                  <tr>
                    <th data-i18n="espnow.role"></th>
                    <th>MAC</th>
                    <th data-i18n="espnow.type"></th>
                    <th data-i18n="espnow.deviceId"></th>
                    <th data-i18n="espnow.channelShort"></th>
                    <th data-i18n="espnow.lastSeen"></th>
                    <th data-i18n="espnow.actions"></th>
                  </tr>
                </thead>
                <tbody id="espnow-peers-body"></tbody>
              </table>
              <div class="button-group" style="margin-top: 10px;">
                <button class="btn-secondary" onclick="refreshEspnowPeers()" data-i18n="espnow.refresh"></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Diagnostic CAN -->
        <div id="diagnostic-tab" class="tab-content">
          <div class="section-title" data-i18n="server.title"></div>
          <div id="diagnostic-notification" class="notification"></div>

          <div class="can-servers-grid">
            <!-- Section: GVRET TCP Server -->
            <div class="profile-section">
              <div class="profile-section-header">
                <h3 data-i18n="server.gvretTitle"></h3>
                <p style="padding: 10px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3B82F6; font-size: 13px; margin-top: 10px;"
                  data-i18n="server.gvretDescription">
                </p>
              </div>
              <div class="profile-section-content">
                <div class="control-group">
                  <label class="control-label" data-i18n="server.gvretStatus"></label>
                  <div id="gvret-status" style="font-weight: 600; color: var(--color-muted);">Chargement...</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.gvretClients"></label>
                  <div id="gvret-clients" style="font-weight: 600;">0</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.gvretPort"></label>
                  <div style="font-weight: 600; font-family: monospace;">23</div>
                </div>
                <label class="toggle-container" for="gvret-autostart">
                  <div class="toggle-switch">
                    <input type="checkbox" id="gvret-autostart" onchange="toggleServerAutostart('gvret', this.checked)">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="server.autostart"></span>
                </label>
                <div class="button-group" style="margin-top: 15px;">
                  <button class="btn-primary" onclick="toggleGvretTcp()" id="gvret-toggle-btn"
                    data-i18n="server.gvretStart"></button>
                </div>
              </div>
            </div>

            <!-- Section: CANServer UDP Server -->
            <div class="profile-section">
              <div class="profile-section-header">
                <h3 data-i18n="server.canserverTitle"></h3>
                <p style="padding: 10px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #F59E0B; font-size: 13px; margin-top: 10px;"
                  data-i18n="server.canserverDescription">
                </p>
              </div>
              <div class="profile-section-content">
                <div class="control-group">
                  <label class="control-label" data-i18n="server.canserverStatus"></label>
                  <div id="canserver-status" style="font-weight: 600; color: var(--color-muted);">Chargement...</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.canserverClients"></label>
                  <div id="canserver-clients" style="font-weight: 600;">0</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.canserverPort"></label>
                  <div style="font-weight: 600; font-family: monospace;">1338</div>
                </div>
                <label class="toggle-container" for="canserver-autostart">
                  <div class="toggle-switch">
                    <input type="checkbox" id="canserver-autostart"
                      onchange="toggleServerAutostart('canserver', this.checked)">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="server.autostart"></span>
                </label>
                <div class="button-group" style="margin-top: 15px;">
                  <button class="btn-primary" onclick="toggleCanserver()" id="canserver-toggle-btn"
                    data-i18n="server.canserverStart"></button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Tab: Logs (WiFi uniquement) -->
        <div id="logs-tab" class="tab-content">
          <div class="section-title" data-i18n="logs.title"></div>
          <div id="logs-notification" class="notification"></div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="logs.streamTitle"></h3>
              <p style="padding: 10px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10B981; font-size: 13px; margin-top: 10px;"
                data-i18n="logs.description">
              </p>
            </div>
            <div class="profile-section-content">
              <div class="control-group">
                <label class="control-label" data-i18n="logs.status"></label>
                <div id="logs-status" style="font-weight: 600; color: var(--color-muted);">Déconnecté</div>
              </div>
              <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" onclick="toggleLiveLogs()" id="logs-toggle-btn"
                  data-i18n="logs.start"></button>
                <button class="btn-secondary" onclick="clearLogs()" data-i18n="logs.clear"></button>
              </div>
              <div
                style="margin-top: 15px; background: #1f2937; border-radius: 4px; padding: 10px; max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; color: #10b981;"
                id="logs-container">
                <div data-i18n="logs.empty"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: OTA -->
        <div id="ota-tab" class="tab-content">
          <div class="section-title" data-i18n="ota.title"></div>
          <div id="ota-notification" class="notification"></div>

          <!-- Section: Version Actuelle -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="ota.currentVersion"></h3>
            </div>
            <div class="profile-section-content">
              <div
                style="padding: 12px; background: var(--color-panel); border-radius: 4px; font-weight: bold; border: 1px solid var(--color-input-border);"
                id="ota-version">
                <span data-i18n="ota.loading"></span>
              </div>
            </div>
          </div>

          <!-- Section: Mise à Jour Firmware -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="ota.updateFirmware"></h3>
              <div id="ota-ble-note"
                style="display: none; margin-top: 10px; padding: 10px; background: rgba(250, 204, 21, 0.1); border-left: 3px solid #FACC15; font-size: 13px;"
                data-i18n="ota.bleNote">
              </div>
            </div>
            <div class="profile-section-content">
              <div class="control-group" id="ota-progress-title">
                <label class="control-label" data-i18n="ota.firmwareFile"></label>
                <input type="file" id="firmware-file" accept=".bin">
              </div>
              <div id="ota-progress-container" style="display: none; margin-top: 15px;">
                <div
                  style="background: var(--color-panel); border-radius: 4px; padding: 15px; border: 1px solid var(--color-input-border);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span data-i18n="ota.progress"></span>
                    <span id="ota-progress-percent" style="font-weight: bold;">0%</span>
                  </div>
                  <div
                    style="background: var(--color-input-border); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="ota-progress-bar"
                      style="background: #E82127; height: 100%; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <div id="ota-status-message" style="margin-top: 10px; font-size: 14px; color: var(--color-muted);">
                  </div>
                  <div id="ota-reboot-countdown"
                    style="margin-top: 6px; font-size: 14px; color: #FACC15; display: none;"></div>
                </div>
              </div>
              <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" onclick="uploadFirmware()" id="ota-upload-btn"
                  data-i18n="ota.upload"></button>
                <button class="btn-secondary" onclick="restartDevice()" id="ota-restart-btn" style="display: none;"
                  data-i18n="ota.restart"></button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal pour nouveau profil -->
      <div id="newProfileModal" class="modal">
        <div class="modal-content">
          <h3 style="margin-bottom: 20px;" data-i18n="profiles.newProfileTitle"></h3>
          <input type="text" id="new-profile-name" data-i18n-placeholder="profiles.profileName"
            style="margin-bottom: 20px;">
          <button class="btn-primary" onclick="createProfile()" data-i18n="profiles.create"></button>
          <button class="btn-secondary" onclick="hideNewProfileDialog()" data-i18n="profiles.cancel"></button>
        </div>
      </div>
      <!-- Modal pour renommer un profil -->
      <div id="renameProfileModal" class="modal">
        <div class="modal-content">
          <h3 style="margin-bottom: 20px;" data-i18n="profiles.renameProfileTitle"></h3>
          <input type="text" id="rename-profile-name" data-i18n-placeholder="profiles.profileName"
            style="margin-bottom: 20px;">
          <button class="btn-primary" onclick="renameProfile()" data-i18n="profiles.rename"></button>
          <button class="btn-secondary" onclick="hideRenameProfileDialog()" data-i18n="profiles.cancel"></button>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>
<script src="i18n.js"></script>
<script src="script.js"></script>

</html>
