<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Light Sync</title>
  <link rel="icon" type="image/png" href="carlightsync64.png">
  <link href="style.css" rel="stylesheet" />
  <!-- Redirect to dashboard on mobile (Capacitor) unless coming from dashboard -->
  <script>
    if (window.Capacitor && !sessionStorage.getItem('from-dashboard')) {
      window.location.href = '/dashboard/dashboard.html';
    }
  </script>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <img src="carlightsync64.png" alt="Logo" class="loading-logo">
      <h2 data-i18n="loading.title">Chargement...</h2>
      <div class="loading-progress">
        <div id="loading-progress-bar" class="loading-progress-bar"></div>
      </div>
      <p id="loading-status" data-i18n="loading.connecting">Javascript & Styles</p>
      <div id="loading-ble-button" class="loading-ble-actions" style="display: none;">
        <button onclick="manualBleConnect()" class="btn-primary" data-i18n="loading.connectBle"></button>
      </div>
      <div id="loading-error" class="loading-error" style="display: none;">
        <p id="loading-error-message"></p>
        <div class="loading-error-actions">
          <button onclick="restart()" class="btn-secondary" data-i18n="loading.restart"></button>
          <button onclick="factoryReset()" class="btn-danger" data-i18n="loading.factoryReset"></button>
          <button onclick="retryLoading()" class="btn-primary" data-i18n="loading.retry"></button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="header-logo">
        <img src="carlightsync64.png" alt="Car Light Sync Logo">
      </div>
      <div class="header-content">
        <h1 data-i18n="app.title"></h1>
        <p data-i18n="app.subtitle"></p>
      </div>
      <div class="header-controls">
        <button id="dashboard-toggle" class="icon-toggle-btn" onclick="switchToDashboard()" title="Dashboard" style="display: none;">
          <span id="dashboard-icon">📊</span>
        </button>
        <button id="language-toggle" class="icon-toggle-btn" onclick="toggleLanguage()" title="Language / Langue">
          <span id="language-icon">FR</span>
        </button>
        <button id="theme-toggle" class="icon-toggle-btn" onclick="toggleTheme()" title="Theme">
          <span id="theme-icon">☀️</span>
        </button>
      </div>
    </div>
    <div id="ble-notification" class="notification"></div>
    <div class="status-bar">
      <div id="ble-status-item" class="status-item status-item-ble" hidden>
        <button id="ble-connect-button" class="btn-secondary ble-icon-button" onclick="toggleBleConnection()"
          title="BLE"></button>
        <div class="status-item">
          <div class="status-label" data-i18n="ble.title"></div>
          <div class="status-value" id="ble-status-text" data-i18n="ble.disconnected"></div>
        </div>
      </div>
      <div id="wifi-status-item" class="status-item">
        <div class="status-label" data-i18n="status.wifi"></div>
        <div class="status-value" id="wifi-status">...</div>
      </div>
      <div class="status-item status-item-can">
        <div class="status-label" data-i18n="status.system"></div>
        <div class="status-can-group">
          <div class="status-can-item">
            <span class="status-can-label">CPU:</span>
            <div class="status-progress-container">
              <div class="status-progress-bar">
                <div class="status-progress-fill" id="cpu-bar"></div>
              </div>
              <span class="status-percentage status-value" id="cpu-status">...</span>
            </div>
          </div>
          <div class="status-can-item">
            <span class="status-can-label" data-i18n="status.memoryLabel"></span>
            <div class="status-progress-container">
              <div class="status-progress-bar">
                <div class="status-progress-fill" id="memory-bar"></div>
              </div>
              <span class="status-percentage status-value" id="memory-status">...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="status-item" id="status-vehicle">
        <div class="status-label" data-i18n="status.vehicle"></div>
        <div class="status-value" id="vehicle-status">...</div>
      </div>
      <div class="status-item status-item-can" id="status-can">
        <div class="status-label" data-i18n="status.canBus"></div>
        <div class="status-can-group">
          <div class="status-can-item">
            <span class="status-can-label">Chassis:</span>
            <span class="status-value" id="can-chassis-status">...</span>
          </div>
          <div class="status-can-item">
            <span class="status-can-label">Body:</span>
            <span class="status-value" id="can-body-status">...</span>
          </div>
        </div>
      </div>
      <div class="status-item" id="status-espnow" style="display: none;">
        <div class="status-label">ESP-NOW</div>
        <div class="status-value" id="espnow-status">slave</div>
      </div>
      <div class="status-item">
        <div class="status-label" data-i18n="status.profile"></div>
        <div class="status-value" id="profile-status">...</div>
      </div>
    </div>
    <div id="app-wrapper" class="app-wrapper">
      <div id="app-content" class="app-content">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="profiles" onclick="switchTab('profiles', event)"
            data-i18n="tabs.profiles"></button>
          <button class="tab" data-tab="events-config" onclick="switchTab('events-config', event)"
            data-i18n="tabs.eventsConfig"></button>
          <button class="tab" id="tab-vehicle" data-tab="vehicle" onclick="switchTab('vehicle', event)"
            data-i18n="tabs.vehicle"></button>
          <button class="tab" data-tab="config" onclick="switchTab('config', event)"
            data-i18n="tabs.hardware"></button>
          <button class="tab" data-tab="espnow" onclick="switchTab('espnow', event)"
            data-i18n="tabs.espnow"></button>
          <button class="tab" id="tab-diagnostic" data-tab="diagnostic" onclick="switchTab('diagnostic', event)"
            data-i18n="tabs.diagnostic"></button>
          <button class="tab" id="tab-logs" data-tab="logs" onclick="switchTab('logs', event)"
            data-i18n="tabs.logs" style="display: none;"></button>
          <button class="tab" data-tab="ota" onclick="switchTab('ota', event)" data-i18n="tabs.ota"></button>
        </div>
        <!-- Tab: Profils -->
        <div id="profiles-tab" class="tab-content active">
          <div class="section-title" data-i18n="profiles.title"></div>
          <div id="profiles-notification" class="notification"></div>

          <!-- Section: Sélection du profil -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="profiles.profileSelection"></h3>
            </div>
            <div class="profile-section-content">
              <div class="control-group">
                <label class="control-label" data-i18n="profiles.activeProfile"></label>
                <select id="profile-select" onchange="activateProfile()">
                  <option value="-1" data-i18n="profiles.loading"></option>
                </select>
              </div>
              <div class="control-group mt-10" id="storage-info" style="display: none;">
                <div class="storage-info-container">
                  <label class="control-label" data-i18n="profiles.storage"></label>
                  <span id="storage-text" class="storage-text">-</span>
                </div>
                <div class="storage-bar">
                  <div id="storage-bar" class="storage-bar-fill" style="width: 0%;">
                  </div>
                </div>
              </div>
              <div class="button-group">
                <button id="profile-new-button" class="btn-secondary" onclick="showNewProfileDialog()"
                  data-i18n="profiles.new"></button>
                <button class="btn-secondary" onclick="showRenameProfileDialog()"
                  data-i18n="profiles.rename"></button>
                <button class="btn-danger" onclick="deleteProfile()" data-i18n="profiles.delete"></button>
                <button class="btn-secondary" onclick="exportProfile()" data-i18n="profiles.export"></button>
                <button id="profile-import-button" class="btn-secondary" onclick="showImportDialog()"
                  data-i18n="profiles.import"></button>
              </div>
            </div>
          </div>

          <!-- Section: Luminosité Dynamique -->
          <div class="profile-section" id="dynamic-brightness-section">
            <div class="profile-section-header">
              <h3 data-i18n="profiles.dynamicBrightness"></h3>
              <p data-i18n="profiles.dynamicBrightnessDesc"></p>
            </div>
            <div class="profile-section-content">
              <label class="toggle-container" for="dynamic-brightness-enabled">
                <div class="toggle-switch">
                  <input type="checkbox" id="dynamic-brightness-enabled">
                  <span class="toggle-slider"></span>
                </div>
                <span class="toggle-label" data-i18n="profiles.dynamicBrightnessEnable"></span>
              </label>
              <div class="control-group mt-15">
                <label class="control-label" data-i18n="profiles.dynamicBrightnessRate"></label>
                <div class="slider-container">
                  <input type="range" id="dynamic-brightness-rate" min="1" max="100" value="50">
                  <span class="slider-value" id="dynamic-brightness-rate-value">50%</span>
                </div>
                <p class="text-sm text-muted mt-8"
                  data-i18n="profiles.dynamicBrightnessHelp">
                </p>
              </div>
              <div class="control-group mt-15">
                <label class="control-label" data-i18n="profiles.dynamicBrightnessExcludeLabel"></label>
                <div class="exclude-controls">
                  <label class="checkbox-container" for="dynamic-brightness-exclude-select-all">
                    <input type="checkbox" id="dynamic-brightness-exclude-select-all">
                    <span data-i18n="profiles.dynamicBrightnessExcludeSelectAll"></span>
                  </label>
                  <input type="text" id="dynamic-brightness-exclude-filter"
                    data-i18n-placeholder="profiles.dynamicBrightnessExcludeFilterPlaceholder">
                </div>
                <div id="dynamic-brightness-exclude-summary" class="text-sm text-muted mt-8"></div>
                <div id="dynamic-brightness-exclude-list" class="exclude-checkbox-list"></div>
                <p class="text-sm text-muted mt-8"
                  data-i18n="profiles.dynamicBrightnessExcludeHelp">
                </p>
              </div>
            </div>
          </div>

          <!-- Section: Effet par Défaut -->
          <div class="profile-section" id="default-effect-section">
            <div class="profile-section-header">
              <h3 data-i18n="profiles.defaultEffect"></h3>
              <p data-i18n="profiles.defaultEffectDesc"></p>
            </div>
            <div class="profile-section-content default-effect-grid">
              <div class="default-effect-card">
                <div class="control-group">
                  <label class="control-label" data-i18n="effects.effect"></label>
                  <select id="default-effect-select" data-effect-options="true">
                    <!-- Will be populated dynamically -->
                  </select>
                </div>
                <div class="default-effect-inline">
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.brightness"></label>
                    <div class="slider-container">
                      <input type="range" id="default-brightness-slider" min="1" max="100" value="50">
                      <span class="slider-value" id="default-brightness-value">50%</span>
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.speed"></label>
                    <div class="slider-container">
                      <input type="range" id="default-speed-slider" min="1" max="100" value="50">
                      <span class="slider-value" id="default-speed-value">50%</span>
                    </div>
                  </div>
                  <div class="control-group">
                  </div>
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.color"></label>
                    <div class="color-picker">
                      <input type="color" id="default-color1" value="#ff0000">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.color2"></label>
                    <div class="color-picker">
                      <input type="color" id="default-color2" value="#00ff00">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" data-i18n="effects.color3"></label>
                    <div class="color-picker">
                      <input type="color" id="default-color3" value="#0000ff">
                    </div>
                  </div>
                </div>
                <div class="control-group m-0">
                  <label class="control-label" data-i18n="eventsConfig.segmentRange"></label>
                  <div class="segment-range-container">
                    <div class="segment-range-slider" id="default-segment-range">
                      <div class="segment-range-track"></div>
                      <div class="segment-range-selected" id="default-segment-range-selected"></div>
                      <input type="range" min="0" max="300" step="1" value="0" class="segment-range-min"
                        id="default-segment-range-min" oninput="updateDefaultSegmentRange()">
                      <input type="range" min="0" max="300" step="1" value="300" class="segment-range-max"
                        id="default-segment-range-max" oninput="updateDefaultSegmentRange()">
                    </div>
                    <div class="segment-range-values">
                      <span data-i18n="eventsConfig.start"></span>: <span id="default-segment-value-start">0</span>
                      |
                      <span data-i18n="eventsConfig.length"></span>: <span
                        id="default-segment-value-length">300</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="default-effect-card">
                <div class="default-effect-stack">
                  <label class="toggle-container" for="default-reverse">
                    <div class="toggle-switch">
                      <input type="checkbox" id="default-reverse">
                      <span class="toggle-slider"></span>
                    </div>
                    <span class="toggle-label" data-i18n="eventsConfig.reverse"></span>
                  </label>
                  <label class="toggle-container" for="default-audio-reactive">
                    <div class="toggle-switch">
                      <input type="checkbox" id="default-audio-reactive">
                      <span class="toggle-slider"></span>
                    </div>
                    <span class="toggle-label" data-i18n="effects.audioReactiveMode"></span>
                  </label>
                </div>
                <hr>
                <div class="default-effect-stack">
                  <div class="control-group m-0">
                    <label class="toggle-container" for="default-accel-pedal-enabled">
                      <div class="toggle-switch">
                        <input type="checkbox" id="default-accel-pedal-enabled">
                        <span class="toggle-slider"></span>
                      </div>
                      <span class="toggle-label" data-i18n="effects.accelPedalEnabled"></span>
                    </label>
                    <p class="default-effect-subtitle" data-i18n="effects.accelPedalEnabledDesc">
                    </p>
                  </div>
                  <div class="control-group m-0">
                    <label class="control-label" data-i18n="effects.accelPedalOffset"></label>
                    <div class="slider-container">
                      <input type="range" id="default-accel-pedal-offset-slider" min="0" max="100" value="0">
                      <span class="slider-value" id="default-accel-pedal-offset-value">0%</span>
                    </div>
                    <p class="default-effect-subtitle" data-i18n="effects.accelPedalOffsetDesc">
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tab: Events Configuration -->
        <div id="events-config-tab" class="tab-content">
          <div class="section-title" data-i18n="eventsConfig.title"></div>
          <div id="events-notification" class="notification"></div>
          <div id="events-loading" class="loading" data-i18n="eventsConfig.loading">
          </div>
          <div id="events-content" style="display: none;">
            <p class="mb-20 text-muted text-md"
              data-i18n="eventsConfig.description">
            </p>
            <div class="control-group mb-20">
              <label class="control-label" data-i18n="eventsConfig.filter"></label>
              <input type="text" id="events-filter-input" data-i18n-placeholder="eventsConfig.filterPlaceholder"
                oninput="filterEvents(this.value)">
            </div>
            <div class="events-accordion-wrapper">
              <div id="events-accordion-container">
                <!-- Will be populated dynamically with accordion items -->
              </div>
            </div>
            <button class="btn-secondary" onclick="loadEventsConfig()"
              data-i18n="eventsConfig.reload"></button>
          </div>
        </div>
        <!-- Tab: Véhicule -->
        <div id="vehicle-tab" class="tab-content">
          <div class="section-title" data-i18n="vehicle.title"></div>

          <!-- Section: État général -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.generalState"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.speed"></div>
                  <div class="vehicle-value" id="v-speed">-- km/h</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.gear"></div>
                  <div class="vehicle-value" id="v-gear">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.brake"></div>
                  <div class="vehicle-value" id="v-brake">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.accelPedal"></div>
                  <div class="vehicle-value" id="v-accel-pedal">0%</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.locked"></div>
                  <div class="vehicle-value" id="v-locked">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Portes -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.doorsTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorFL"></div>
                  <div class="vehicle-value" id="v-door-fl">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorFR"></div>
                  <div class="vehicle-value" id="v-door-fr">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorRL"></div>
                  <div class="vehicle-value" id="v-door-rl">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.doorRR"></div>
                  <div class="vehicle-value" id="v-door-rr">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.trunk"></div>
                  <div class="vehicle-value" id="v-trunk">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.frunk"></div>
                  <div class="vehicle-value" id="v-frunk">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Charge -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.chargeTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.charging"></div>
                  <div class="vehicle-value" id="v-charging">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.chargePercent"></div>
                  <div class="vehicle-value" id="v-charge">--%</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.chargePower"></div>
                  <div class="vehicle-value" id="v-charge-power">-- kW</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Energie / Puissance -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.energyTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.trainType"></div>
                  <div class="vehicle-value" id="v-train-type">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.packEnergy"></div>
                  <div class="vehicle-value" id="v-pack-energy">-- kWh</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.remainingEnergy"></div>
                  <div class="vehicle-value" id="v-remaining-energy">-- kWh</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.rearPowerLimit"></div>
                  <div class="vehicle-value" id="v-rear-power">--</div>
                </div>
                <div class="vehicle-item" id="v-front-power-item">
                  <div class="vehicle-label" data-i18n="vehicle.frontPowerLimit"></div>
                  <div class="vehicle-value" id="v-front-power">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.maxRegen"></div>
                  <div class="vehicle-value" id="v-max-regen">-- kW</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Lumières -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.lightsTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.headlights"></div>
                  <div class="vehicle-value" id="v-headlights">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.highBeams"></div>
                  <div class="vehicle-value" id="v-high-beams">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.fogLights"></div>
                  <div class="vehicle-value" id="v-fog-lights">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.turnSignal"></div>
                  <div class="vehicle-value" id="v-turn-signal">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Blindspot -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.blindspot"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotLeft"></div>
                  <div class="vehicle-value" id="v-blindspot-left">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotRight"></div>
                  <div class="vehicle-value" id="v-blindspot-right">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotLeftAlert"></div>
                  <div class="vehicle-value" id="v-blindspot-left-alert">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.blindspotRightAlert"></div>
                  <div class="vehicle-value" id="v-blindspot-right-alert">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Side Collision -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.sideCollision"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sideCollisionLeft"></div>
                  <div class="vehicle-value" id="v-side-collision-left">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sideCollisionRight"></div>
                  <div class="vehicle-value" id="v-side-collision-right">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Lane departure -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.laneDeparture"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureLeftLv1"></div>
                  <div class="vehicle-value" id="v-lane-departure-left-lv1">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureLeftLv2"></div>
                  <div class="vehicle-value" id="v-lane-departure-left-lv2">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureRightLv1"></div>
                  <div class="vehicle-value" id="v-lane-departure-right-lv1">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.laneDepartureRightLv2"></div>
                  <div class="vehicle-value" id="v-lane-departure-right-lv2">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Autres -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.othersTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.batterylv"></div>
                  <div class="vehicle-value" id="v-battery-lv">-- V</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.batteryhv"></div>
                  <div class="vehicle-value" id="v-battery-hv">-- V</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.odometer"></div>
                  <div class="vehicle-value" id="v-odometer">-- km</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.nightMode"></div>
                  <div class="vehicle-value" id="v-night">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.brightness"></div>
                  <div class="vehicle-value" id="v-brightness">--</div>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="vehicle.sentryTitle"></h3>
            </div>
            <div class="profile-section-content">
              <div class="vehicle-grid">
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.autopilot"></div>
                  <div class="vehicle-value" id="v-autopilot">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.autopilotAlerte"></div>
                  <div class="vehicle-value" id="v-autopilot-alert">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sentryMode"></div>
                  <div class="vehicle-value" id="v-sentry-mode">--</div>
                </div>
                <div class="vehicle-item">
                  <div class="vehicle-label" data-i18n="vehicle.sentryAlert"></div>
                  <div class="vehicle-value" id="v-sentry-alert">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tab: Configuration -->
        <div id="config-tab" class="tab-content">
          <div class="section-title" data-i18n="config.title"></div>
          <div id="config-notification" class="notification"></div>

          <!-- Section: Configuration LED -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="config.ledSettings"></h3>
            </div>
            <div class="profile-section-content">
              <div class="control-group">
                <label class="control-label" data-i18n="config.ledCount"></label>
                <input type="number" id="led-count" value="" min="1" max="200" onchange="saveHardwareConfig()">
              </div>
            </div>
            <div id="wheel-control-section">
              <div class="profile-section-header">
                <h3 data-i18n="config.wheelSettings"></h3>
              </div>
              <div class="profile-section-content">
                <div class="control-row mt-10">
                  <label class="toggle-container" for="wheel-control-toggle">
                    <div class="toggle-switch">
                      <input type="checkbox" id="wheel-control-toggle" onchange="saveHardwareConfig()">
                      <span class="toggle-slider"></span>
                    </div>
                    <span class="toggle-label" data-i18n="config.wheelControl"></span>
                  </label>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="config.wheelControlDesc"></label>
                  <div class="flex-row gap-10 max-w-320">
                    <input type="number" id="wheel-speed-limit" min="0" max="100" step="5" value="5" class="w-120"
                      onchange="saveHardwareConfig()">
                    <span data-i18n="config.wheelSpeedLimit"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="button-group mt-20">
              <button class="btn-secondary" onclick="loadHardwareConfig()"
                data-i18n="config.reload"></button>
              <button class="btn-danger" onclick="restartDevice()" data-i18n="config.restart"></button>
            </div>
          </div>

          <!-- Section: Configuration Audio -->
          <div class="profile-section" id="audio-section">
            <div class="profile-section-header">
              <h3 data-i18n="audio.title"></h3>
              <p class="warning-box"
                data-i18n="audio.warning">
              </p>
            </div>
            <div class="profile-section-content">
              <div class="flex-row gap-15 mb-15">
                <label class="toggle-container" for="audio-enable">
                  <div class="toggle-switch">
                    <input type="checkbox" id="audio-enable" onchange="toggleAudio(this.checked)">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="audio.enable"></span>
                </label>
                <span id="audio-status" class="font-bold text-muted"
                  data-i18n="audio.disabled"></span>
              </div>

              <div id="audio-settings" style="display: none;">
                <div class="control-group">
                  <label class="control-label" data-i18n="audio.sensitivity"></label>
                  <div class="slider-container">
                    <input type="range" id="audio-sensitivity" min="1" max="255" value="128"
                      oninput="updateAudioValue('sensitivity', this.value)">
                    <span class="slider-value" id="audio-sensitivity-value">128</span>
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label" data-i18n="audio.gain"></label>
                  <div class="slider-container">
                    <input type="range" id="audio-gain" min="1" max="255" value="128"
                      oninput="updateAudioValue('gain', this.value)">
                    <span class="slider-value" id="audio-gain-value">128</span>
                  </div>
                </div>

                <label class="toggle-container" for="audio-auto-gain">
                  <div class="toggle-switch">
                    <input type="checkbox" id="audio-auto-gain" onchange="saveAudioConfig()">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="audio.autoGain"></span>
                </label>
              </div>

              <div id="audio-calibration-box" class="audio-calibration-box">
                <div class="audio-calibration-header">
                  <div>
                    <div class="section-title" data-i18n="audio.calibrationTitle"></div>
                    <div id="audio-calibration-status" class="audio-calibration-status"
                      data-i18n="audio.notCalibrated"></div>
                    <div class="audio-calibration-details">
                      <span data-i18n="audio.calibrationNoise"></span>: <strong
                        id="audio-calibration-noise">-</strong>
                      <span class="mx-6">|</span>
                      <span data-i18n="audio.calibrationPeak"></span>: <strong id="audio-calibration-peak">-</strong>
                    </div>
                  </div>
                  <div class="button-group">
                    <button id="audio-calibrate-btn" class="btn-primary" onclick="startAudioCalibration()"
                      data-i18n="audio.calibrate"></button>
                    <button id="audio-reset-calibration-btn" class="btn-danger" onclick="resetAudioCalibration()"
                      data-i18n="audio.resetCalibration"></button>
                  </div>
                </div>
                <p class="audio-calibration-hint"
                  data-i18n="audio.calibrationHint">
                </p>
              </div>

              <div id="audio-data" class="audio-data-section">
                <h4 class="audio-data-title" data-i18n="audio.liveData"></h4>
                <div class="audio-data-grid">
                  <div>
                    <span data-i18n="audio.amplitude"></span>:
                    <strong id="audio-amplitude-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.rawAmplitude"></span>:
                    <strong id="audio-raw-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.calibratedAmplitude"></span>:
                    <strong id="audio-calibrated-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.bpm"></span>:
                    <strong id="audio-bpm-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.bass"></span>:
                    <strong id="audio-bass-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.mid"></span>:
                    <strong id="audio-mid-value">-</strong>
                  </div>
                  <div>
                    <span data-i18n="audio.treble"></span>:
                    <strong id="audio-treble-value">-</strong>
                  </div>
                </div>
              </div>

              <!-- FFT Advanced Mode -->
              <div id="audio-fft-data" class="section mt-30">
                <div class="section-title" data-i18n="fft.title"></div>

                <div class="info-box-cyan">
                  <small data-i18n="fft.autoInfo">
                  </small>
                </div>

                <div id="fftStatusBox" class="mt-10" style="display: none;">
                  <div class="fft-status-box">
                    <div class="fft-grid-2">
                      <div>
                        <span data-i18n="fft.peakFreq"></span>:
                        <strong id="fftPeakFreq" class="fft-value-green">-</strong> Hz
                      </div>
                      <div>
                        <span data-i18n="fft.centroid"></span>:
                        <strong id="fftCentroid" class="fft-value-blue">-</strong> Hz
                      </div>
                    </div>

                    <div class="fft-grid-3">
                      <div>
                        <span data-i18n="fft.kick"></span>:
                        <strong id="fftKick">-</strong>
                      </div>
                      <div>
                        <span data-i18n="fft.snare"></span>:
                        <strong id="fftSnare">-</strong>
                      </div>
                      <div>
                        <span data-i18n="fft.vocal"></span>:
                        <strong id="fftVocal">-</strong>
                      </div>
                    </div>

                    <!-- Canvas pour visualisation spectre -->
                    <div class="fft-spectrum-container">
                      <div class="fft-spectrum-title" data-i18n="fft.spectrum"></div>
                      <canvas id="fftSpectrumCanvas" width="600" height="200"
                        class="fft-spectrum-canvas"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section: Zone Dangereuse -->
          <div class="profile-section danger-zone-section">
            <div class="profile-section-header">
              <h3 class="danger-zone-title" data-i18n="config.dangerZone"></h3>
              <p class="danger-box"
                data-i18n="config.factoryResetWarning">
              </p>
            </div>
            <div class="profile-section-content">
              <button class="btn-danger" onclick="confirmFactoryReset()"
                data-i18n="config.factoryReset"></button>
            </div>
          </div>
        </div>

        <!-- Tab: ESP-NOW -->
        <div id="espnow-tab" class="tab-content">
          <div class="section-title" data-i18n="espnow.title"></div>
          <div id="espnow-notifications">
            <div id="espnow-notification-config" class="notification"></div>
            <div id="espnow-notification-pairing" class="notification"></div>
            <div id="espnow-notification-peers" class="notification"></div>
            <div id="espnow-notification-test" class="notification"></div>
            <div id="espnow-notification-disconnect" class="notification"></div>
          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="espnow.configTitle"></h3>
              <p class="profile-header-description" data-i18n="espnow.configDescription">
              </p>
            </div>
            <div class="profile-section-content">
              <div class="espnow-grid">
                <div class="control-group">
                  <label class="control-label" data-i18n="config.espnowRole"></label>
                  <select id="espnow-role" onchange="saveEspnowConfig()">
                    <option value="master" data-i18n="config.espnowRoleMaster"></option>
                    <option value="slave" data-i18n="config.espnowRoleSlave"></option>
                  </select>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="config.espnowType"></label>
                  <select id="espnow-type" onchange="saveEspnowConfig()">
                  </select>
                </div>
                <div class="espnow-status-card">
                  <div class="espnow-status-label" data-i18n="espnow.channel"></div>
                  <div class="espnow-status-value" id="espnow-channel">--</div>
                  <div class="espnow-status-sub" data-i18n="espnow.channelHelp"></div>
                </div>
              <div class="espnow-status-card">
                <div class="espnow-status-label" data-i18n="espnow.pairingState"></div>
                <div class="espnow-status-value" id="espnow-pairing-state">--</div>
                <div class="espnow-status-sub" id="espnow-role-summary">--</div>
              </div>
              <div class="espnow-status-card">
                <div class="espnow-status-label" data-i18n="espnow.selfTitle"></div>
                <div class="espnow-status-value" id="espnow-self-id">ID: --</div>
                <div class="espnow-status-sub" id="espnow-self-mac">MAC: --</div>
              </div>
            </div>
            <div id="espnow-master-card" class="espnow-master-card" style="display: none;">
              <div class="espnow-master-header" data-i18n="espnow.masterConnected"></div>
              <div class="espnow-master-grid">
                <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterMac"></div>
                    <div class="espnow-master-value" id="espnow-master-mac">--</div>
                  </div>
                  <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterId"></div>
                    <div class="espnow-master-value" id="espnow-master-id">--</div>
                  </div>
                  <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterChannel"></div>
                    <div class="espnow-master-value" id="espnow-master-channel">--</div>
                  </div>
                  <div>
                    <div class="espnow-master-label" data-i18n="espnow.masterLastSeen"></div>
                    <div class="espnow-master-value" id="espnow-master-last">--</div>
                  </div>
                </div>
              </div>
              <div class="button-group mt-15">
                <button class="btn-primary" id="espnow-pairing-button" onclick="startEspnowPairing()" data-i18n="config.espnowPairing"></button>
              </div>
            </div>
          </div>

          <div class="profile-section" id="espnow-peers-section" style="display: none;">
            <div class="profile-section-header">
              <h3 data-i18n="espnow.peersTitle"></h3>
              <p id="espnow-peers-subtitle" class="profile-header-description" data-i18n="espnow.peersSubtitle"></p>
            </div>
            <div class="profile-section-content">
              <div id="espnow-peers-empty" class="text-muted" data-i18n="espnow.noPeers"></div>
              <table class="config-table mt-10" style="display: none;" id="espnow-peers-table">
                <thead>
                  <tr>
                    <th data-i18n="espnow.role"></th>
                    <th>MAC</th>
                    <th data-i18n="espnow.type"></th>
                    <th data-i18n="espnow.deviceId"></th>
                    <th data-i18n="espnow.channelShort"></th>
                    <th data-i18n="espnow.lastSeen"></th>
                    <th data-i18n="espnow.actions"></th>
                  </tr>
                </thead>
                <tbody id="espnow-peers-body"></tbody>
              </table>
              <div class="button-group mt-10">
                <button class="btn-secondary" onclick="refreshEspnowPeers()" data-i18n="espnow.refresh"></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Diagnostic CAN -->
        <div id="diagnostic-tab" class="tab-content">
          <div class="section-title" data-i18n="server.title"></div>
          <div id="diagnostic-notification" class="notification"></div>

          <div class="can-servers-grid">
            <!-- Section: GVRET TCP Server -->
            <div class="profile-section">
              <div class="profile-section-header">
                <h3 data-i18n="server.gvretTitle"></h3>
                <p class="info-box-blue"
                  data-i18n="server.gvretDescription">
                </p>
              </div>
              <div class="profile-section-content">
                <div class="control-group">
                  <label class="control-label" data-i18n="server.gvretStatus"></label>
                  <div id="gvret-status" class="font-600 text-muted">Chargement...</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.gvretClients"></label>
                  <div id="gvret-clients" class="font-600">0</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.gvretPort"></label>
                  <div class="font-600 font-mono">23</div>
                </div>
                <label class="toggle-container" for="gvret-autostart">
                  <div class="toggle-switch">
                    <input type="checkbox" id="gvret-autostart" onchange="toggleServerAutostart('gvret', this.checked)">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="server.autostart"></span>
                </label>
                <div class="button-group mt-15">
                  <button class="btn-primary" onclick="toggleGvretTcp()" id="gvret-toggle-btn"
                    data-i18n="server.gvretStart"></button>
                </div>
              </div>
            </div>

            <!-- Section: CANServer UDP Server -->
            <div class="profile-section">
              <div class="profile-section-header">
                <h3 data-i18n="server.canserverTitle"></h3>
                <p class="info-box-orange"
                  data-i18n="server.canserverDescription">
                </p>
              </div>
              <div class="profile-section-content">
                <div class="control-group">
                  <label class="control-label" data-i18n="server.canserverStatus"></label>
                  <div id="canserver-status" class="font-600 text-muted">Chargement...</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.canserverClients"></label>
                  <div id="canserver-clients" class="font-600">0</div>
                </div>
                <div class="control-group">
                  <label class="control-label" data-i18n="server.canserverPort"></label>
                  <div class="font-600 font-mono">1338</div>
                </div>
                <label class="toggle-container" for="canserver-autostart">
                  <div class="toggle-switch">
                    <input type="checkbox" id="canserver-autostart"
                      onchange="toggleServerAutostart('canserver', this.checked)">
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-label" data-i18n="server.autostart"></span>
                </label>
                <div class="button-group mt-15">
                  <button class="btn-primary" onclick="toggleCanserver()" id="canserver-toggle-btn"
                    data-i18n="server.canserverStart"></button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Tab: Logs (WiFi uniquement) -->
        <div id="logs-tab" class="tab-content">
          <div class="section-title" data-i18n="logs.title"></div>
          <div id="logs-notification" class="notification"></div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="logs.streamTitle"></h3>
              <p class="info-box-green"
                data-i18n="logs.description">
              </p>
            </div>
            <div class="profile-section-content">
              <div class="control-group">
                <label class="control-label" data-i18n="logs.statusLabel"></label>
                <div id="logs-status" class="font-600 text-muted" data-i18n="logs.disconnected"></div>
              </div>
              <div class="button-group mt-15">
                <button class="btn-primary" onclick="toggleLiveLogs()" id="logs-toggle-btn"
                  data-i18n="logs.start"></button>
                <button class="btn-secondary" onclick="clearLogs()" data-i18n="logs.clear"></button>
              </div>
              <div class="logs-container" id="logs-container">
                <div data-i18n="logs.empty"></div>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="logs.fileTitle"></h3>
              <p class="info-box-blue" data-i18n="logs.fileDescription"></p>
            </div>
            <div class="profile-section-content">
              <label class="toggle-container" for="logs-file-enabled">
                <div class="toggle-switch">
                  <input type="checkbox" id="logs-file-enabled" onchange="toggleFileLogs(event)">
                  <span class="toggle-slider"></span>
                </div>
                <span class="toggle-label" data-i18n="logs.fileEnable"></span>
              </label>
              <div class="control-group mt-15">
                <div id="logs-file-status" class="font-600 text-muted"></div>
              </div>
              <div class="control-group mt-15">
                <label class="control-label" data-i18n="logs.fileListLabel"></label>
                <div id="logs-file-list" class="logs-file-list"></div>
              </div>
              <div class="button-group mt-10">
                <button class="btn-danger" id="logs-file-purge-btn" onclick="purgeLogFiles()" data-i18n="logs.filePurge"></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: OTA -->
        <div id="ota-tab" class="tab-content">
          <div class="section-title" data-i18n="ota.title"></div>
          <div id="ota-notification" class="notification"></div>

          <!-- Section: Version Actuelle -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="ota.currentVersion"></h3>
            </div>
            <div class="profile-section-content">
              <div class="ota-version-box" id="ota-version">
                <span data-i18n="ota.loading"></span>
              </div>
            </div>
          </div>

          <!-- Section: Mise à Jour Firmware -->
          <div class="profile-section">
            <div class="profile-section-header">
              <h3 data-i18n="ota.updateFirmware"></h3>
              <div id="ota-ble-note" class="warning-box" style="display: none;"
                data-i18n="ota.bleNote">
              </div>
            </div>
            <div class="profile-section-content">
              <div class="control-group" id="ota-progress-title">
                <label class="control-label" data-i18n="ota.firmwareFile"></label>
                <input type="file" id="firmware-file" accept=".bin">
              </div>
              <div id="ota-progress-container" class="mt-15" style="display: none;">
                <div class="ota-progress-panel">
                  <div class="ota-progress-header">
                    <span data-i18n="ota.progress"></span>
                    <span id="ota-progress-percent" class="font-bold">0%</span>
                  </div>
                  <div class="ota-progress-track">
                    <div id="ota-progress-bar" class="ota-progress-bar-fill" style="width: 0%;"></div>
                  </div>
                  <div id="ota-status-message" class="ota-status-message">
                  </div>
                  <div id="ota-reboot-countdown" class="ota-reboot-countdown" style="display: none;"></div>
                </div>
              </div>
              <div class="button-group mt-15">
                <button class="btn-primary" onclick="uploadFirmware()" id="ota-upload-btn"
                  data-i18n="ota.upload"></button>
                <button class="btn-secondary" onclick="restartDevice()" id="ota-restart-btn" style="display: none;"
                  data-i18n="ota.restart"></button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal pour nouveau profil -->
      <div id="newProfileModal" class="modal">
        <div class="modal-content">
          <h3 class="mb-20" data-i18n="profiles.newProfileTitle"></h3>
          <input type="text" id="new-profile-name" data-i18n-placeholder="profiles.profileName"
            class="modal-input mb-20">
          <button class="btn-primary" onclick="createProfile()" data-i18n="profiles.create"></button>
          <button class="btn-secondary" onclick="hideNewProfileDialog()" data-i18n="profiles.cancel"></button>
        </div>
      </div>
      <!-- Modal pour renommer un profil -->
      <div id="renameProfileModal" class="modal">
        <div class="modal-content">
          <h3 class="mb-20" data-i18n="profiles.renameProfileTitle"></h3>
          <input type="text" id="rename-profile-name" data-i18n-placeholder="profiles.profileName"
            class="modal-input mb-20">
          <button class="btn-primary" onclick="renameProfile()" data-i18n="profiles.rename"></button>
          <button class="btn-secondary" onclick="hideRenameProfileDialog()" data-i18n="profiles.cancel"></button>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>
<script src="i18n.js"></script>
<script src="script.js"></script>

</html>
